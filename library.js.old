'use strict';

const meta = require.main.require('./src/meta');
const winston = require.main.require('winston');
const topics = require.main.require('./src/topics');
const db = require.main.require('./src/database');

const plugin = {};

/**
 * Rewrite URLs in email content from NodeBB URLs to custom frontend URLs
 */
plugin.rewriteEmailUrls = async function (data) {
	try {
		const settings = await meta.settings.get('custom-email-urls');

		// Get the custom frontend URL from settings
		const customFrontendUrl = settings.customFrontendUrl;
		// Use nodebbUrl from settings if provided and not empty, otherwise use meta.config.url
		const nodebbUrl = (settings.nodebbUrl && settings.nodebbUrl.trim()) ? settings.nodebbUrl.trim() : meta.config.url;

		winston.info(`[plugin/custom-email-urls] Hook called - customFrontendUrl: ${customFrontendUrl}, nodebbUrl: ${nodebbUrl}, meta.config.url: ${meta.config.url}`);

		// If no custom URL is configured, just pass through without rewriting
		if (!customFrontendUrl || !customFrontendUrl.trim() || !nodebbUrl || typeof nodebbUrl !== 'string') {
			winston.warn('[plugin/custom-email-urls] Skipping URL rewrite - configuration missing or invalid');
			return data;
		}

		// Ensure URLs don't have trailing slashes
		const fromUrl = nodebbUrl.replace(/\/$/, '');
		const toUrl = customFrontendUrl.replace(/\/$/, '');

		winston.info(`[plugin/custom-email-urls] Rewriting URLs from ${fromUrl} to ${toUrl}`);

		// Rewrite URLs in subject
		if (data.subject) {
			data.subject = await replaceUrls(data.subject, fromUrl, toUrl, settings);
		}

		// Rewrite URLs in plaintext content
		if (data.plaintext) {
			data.plaintext = await replaceUrls(data.plaintext, fromUrl, toUrl, settings);
		}

		// Rewrite URLs in HTML content
		if (data.html) {
			data.html = await replaceUrls(data.html, fromUrl, toUrl, settings);
		}

		return data;
	} catch (err) {
		winston.error('[plugin/custom-email-urls] Error rewriting email URLs:', err);
		return data;
	}
};

/**
 * Replace NodeBB URLs with custom frontend URLs
 */
async function replaceUrls(content, fromUrl, toUrl, settings) {
	if (!content || typeof content !== 'string') {
		return content;
	}

	// First, handle special topic URL transformations if enabled
	if (settings.enableTopicTransform === 'on') {
		content = await transformTopicUrls(content, fromUrl, toUrl, settings);
	}

	// Define URL mappings for different NodeBB paths
	// Use individual mapping fields if available, otherwise fall back to urlMappings textarea
	const urlMappings = buildUrlMappings(settings);

	// Apply custom mappings
	let result = content;
	for (const [nodebbPath, customPath] of Object.entries(urlMappings)) {
		// Skip /topic/ if we're using custom transform
		if (nodebbPath === '/topic/' && settings.enableTopicTransform === 'on') {
			continue;
		}

		// Match both plain URLs and URLs in href attributes
		const patterns = [
			// Plain URLs (with word boundaries)
			new RegExp(`${escapeRegex(fromUrl)}${escapeRegex(nodebbPath)}([?&#]|$)`, 'g'),
			// URLs in href attributes
			new RegExp(`(href=["'])${escapeRegex(fromUrl)}${escapeRegex(nodebbPath)}([?&#"'])`, 'g'),
		];

		patterns.forEach((pattern, index) => {
			if (index === 0) {
				// Plain URL replacement
				result = result.replace(pattern, `${toUrl}${customPath}$1`);
			} else {
				// href attribute replacement
				result = result.replace(pattern, `$1${toUrl}${customPath}$2`);
			}
		});
	}

	// Fallback: replace any remaining instances of the base NodeBB URL
	result = result.replace(new RegExp(escapeRegex(fromUrl), 'g'), toUrl);

	return result;
}

/**
 * Transform topic URLs from NodeBB format to custom format with database lookups
 * NodeBB format: /topic/{tid}/{slug}
 * Custom format: /topic/{cid}/{tid} (category_id/topic_id)
 */
async function transformTopicUrls(content, fromUrl, toUrl, settings) {
	// Pattern to match topic URLs: /topic/123/slug or /topic/123
	const topicUrlPattern = new RegExp(
		`${escapeRegex(fromUrl)}/topic/(\\d+)(?:/[^\\s"'<>]*)?`,
		'g'
	);

	// Find all topic IDs in the content
	const matches = [...content.matchAll(topicUrlPattern)];
	const tids = [...new Set(matches.map(m => m[1]))]; // unique topic IDs

	if (tids.length === 0) {
		return content;
	}

	winston.info(`[plugin/custom-email-urls] Transforming ${tids.length} unique topic URLs`);

	// Batch fetch category IDs for all topics
	const tidToCidMap = {};
	try {
		const topicData = await topics.getTopicsFields(tids, ['tid', 'cid']);
		topicData.forEach((topic) => {
			if (topic && topic.tid && topic.cid) {
				tidToCidMap[topic.tid] = topic.cid;
				winston.info(`[plugin/custom-email-urls] Topic ${topic.tid} -> Category ${topic.cid}`);
			}
		});
	} catch (err) {
		winston.error('[plugin/custom-email-urls] Error fetching topic category IDs:', err);
		return content; // Return original content if database lookup fails
	}

	// Replace each topic URL with the custom format
	let result = content;
	result = result.replace(topicUrlPattern, (match, tid) => {
		const cid = tidToCidMap[tid];
		if (cid) {
			// Transform to custom format: /topic/{cid}/{tid}
			const customPath = settings.mapping_topic || '/topic/';
			const newUrl = `${toUrl}${customPath}${cid}/${tid}`;
			winston.info(`[plugin/custom-email-urls] Transformed ${match} -> ${newUrl}`);
			return newUrl;
		}
		// If we couldn't find the category, keep original URL but change domain
		winston.warn(`[plugin/custom-email-urls] No category found for topic ${tid}, using fallback`);
		return match.replace(fromUrl, toUrl);
	});

	return result;
}

/**
 * Get default URL mappings for common NodeBB paths
 */
function getDefaultUrlMappings() {
	return {
		'/topic/': '/topic/',
		'/post/': '/post/',
		'/user/': '/user/',
		'/category/': '/category/',
		'/notifications': '/notifications',
		'/unsubscribe/': '/unsubscribe/',
		'/reset/': '/reset/',
		'/register': '/register',
		'/login': '/login',
		'/tags/': '/tags/',
		'/groups/': '/groups/',
	};
}

/**
 * Build URL mappings from individual settings fields
 */
function buildUrlMappings(settings) {
	const mappings = {};

	// Map individual fields to their NodeBB paths
	const fieldMap = {
		mapping_topic: '/topic/',
		mapping_post: '/post/',
		mapping_user: '/user/',
		mapping_category: '/category/',
		mapping_notifications: '/notifications',
		mapping_unsubscribe: '/unsubscribe/',
		mapping_reset: '/reset/',
		mapping_register: '/register',
		mapping_login: '/login',
		mapping_tags: '/tags/',
		mapping_groups: '/groups/',
	};

	// Build mappings from settings, using defaults if not set
	const defaults = getDefaultUrlMappings();
	for (const [fieldName, nodebbPath] of Object.entries(fieldMap)) {
		if (settings[fieldName] && settings[fieldName].trim()) {
			mappings[nodebbPath] = settings[fieldName].trim();
		} else {
			mappings[nodebbPath] = defaults[nodebbPath];
		}
	}

	return mappings;
}

/**
 * Parse custom URL mappings from settings
 * Format: nodebb_path=custom_path (one per line)
 */
function parseUrlMappings(mappingsString) {
	const mappings = getDefaultUrlMappings();

	if (!mappingsString || typeof mappingsString !== 'string') {
		return mappings;
	}

	const lines = mappingsString.split('\n').filter(line => line.trim());

	for (const line of lines) {
		const [nodebbPath, customPath] = line.split('=').map(s => s.trim());
		if (nodebbPath && customPath) {
			mappings[nodebbPath] = customPath;
		}
	}

	return mappings;
}

/**
 * Escape special regex characters
 */
function escapeRegex(string) {
	return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
}

/**
 * Add navigation item to admin panel
 */
plugin.addAdminNavigation = async function (header) {
	header.plugins.push({
		route: '/plugins/custom-email-urls',
		icon: 'fa-envelope',
		name: 'Custom Email URLs',
	});

	return header;
};

/**
 * Initialize plugin and register admin routes
 */
plugin.init = function (params, callback) {
	const { router, middleware } = params;

	const renderAdmin = function (req, res) {
		res.render('admin/plugins/custom-email-urls', {
			title: 'Custom Email URLs',
		});
	};

	router.get('/admin/plugins/custom-email-urls', middleware.admin.buildHeader, renderAdmin);
	router.get('/api/admin/plugins/custom-email-urls', renderAdmin);

	callback();
};

module.exports = plugin;
